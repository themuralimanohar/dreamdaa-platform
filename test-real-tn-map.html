<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Tamil Nadu Real Map Test</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <style>
        /* Layout */
        body { margin: 0; font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif; }
        .wrap { display: grid; grid-template-columns: 1fr min(360px, 38vw); height: 100vh; }
        #map { width: 100%; height: 100%; }
        aside {
            border-left: 1px solid #e5e7eb; padding: 16px; overflow: auto;
            background: #fafafa;
        }
        h2 { margin: 0 0 8px; font-size: 18px; }
        .meta { font-size: 13px; color: #6b7280; margin-bottom: 8px; }
        .pill { display:inline-block; padding:2px 8px; border-radius:999px; background:#eef2ff; font-size:12px; }
        .legend { margin-top:12px; font-size:12px; color:#555 }
        .credit { position:absolute; z-index:400; right:10px; bottom:8px; background:#fff; padding:4px 8px; border-radius:6px; border:1px solid #e5e7eb; font-size:12px; }
        
        .status-box { margin: 8px 0; padding: 8px; border-radius: 6px; }
        .needs-funding { background: #fef2f2; border-left: 3px solid #ef4444; }
        .partial-funding { background: #fffbeb; border-left: 3px solid #f59e0b; }
        .well-funded { background: #eff6ff; border-left: 3px solid #3b82f6; }
        .fully-funded { background: #f0fdf4; border-left: 3px solid #10b981; }
    </style>
</head>
<body>
    <div class="wrap">
        <div id="map"></div>
        <aside id="panel">
            <h2>TN District Explorer</h2>
            <div class="meta">Click a district to see school coverage details</div>
            <p>This map shows real Tamil Nadu district boundaries with school funding status. Each district is colored based on coverage percentage.</p>
            <div class="legend">
                <div style="margin: 8px 0;">
                    <div style="display: inline-block; width: 12px; height: 12px; background: #ef4444; margin-right: 6px;"></div>
                    Needs Funding (0-40%)
                </div>
                <div style="margin: 8px 0;">
                    <div style="display: inline-block; width: 12px; height: 12px; background: #f59e0b; margin-right: 6px;"></div>
                    Partially Funded (41-70%)
                </div>
                <div style="margin: 8px 0;">
                    <div style="display: inline-block; width: 12px; height: 12px; background: #3b82f6; margin-right: 6px;"></div>
                    Well Funded (71-99%)
                </div>
                <div style="margin: 8px 0;">
                    <div style="display: inline-block; width: 12px; height: 12px; background: #10b981; margin-right: 6px;"></div>
                    Fully Funded (100%)
                </div>
            </div>
            <div class="legend">Tip: Ctrl/Cmd + scroll to zoom the map.</div>
        </aside>
    </div>

    <div class="credit">Real TN boundaries via GeoJSON</div>

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script>
        // Tamil Nadu districts data with school coverage
        const tamilNaduDistricts = [
            { name: 'Chennai', totalSchools: 687, coveredSchools: 687, fundingStatus: 'complete' },
            { name: 'Coimbatore', totalSchools: 823, coveredSchools: 456, fundingStatus: 'medium' },
            { name: 'Madurai', totalSchools: 654, coveredSchools: 321, fundingStatus: 'medium' },
            { name: 'Salem', totalSchools: 543, coveredSchools: 234, fundingStatus: 'low' },
            { name: 'Tiruchirappalli', totalSchools: 456, coveredSchools: 345, fundingStatus: 'high' },
            { name: 'Tirunelveli', totalSchools: 398, coveredSchools: 187, fundingStatus: 'low' },
            { name: 'Vellore', totalSchools: 432, coveredSchools: 298, fundingStatus: 'high' },
            { name: 'Erode', totalSchools: 376, coveredSchools: 234, fundingStatus: 'medium' },
            { name: 'Thanjavur', totalSchools: 445, coveredSchools: 156, fundingStatus: 'low' },
            { name: 'Dindigul', totalSchools: 334, coveredSchools: 223, fundingStatus: 'medium' },
            { name: 'Cuddalore', totalSchools: 387, coveredSchools: 198, fundingStatus: 'low' },
            { name: 'Kanchipuram', totalSchools: 456, coveredSchools: 334, fundingStatus: 'high' }
        ];

        // Helper functions
        function getCoveragePercentage(district) {
            return Math.round((district.coveredSchools / district.totalSchools) * 100);
        }

        function getDistrictColor(fundingStatus) {
            const colors = {
                'low': '#ef4444',      // Red
                'medium': '#f59e0b',   // Orange  
                'high': '#3b82f6',     // Blue
                'complete': '#10b981'  // Green
            };
            return colors[fundingStatus] || '#6b7280';
        }

        function getFundingStatusText(status) {
            const statusTexts = {
                'low': 'Needs Funding',
                'medium': 'Partially Funded', 
                'high': 'Well Funded',
                'complete': 'Fully Funded'
            };
            return statusTexts[status] || 'Unknown';
        }

        // Create district lookup map
        const districtMap = new Map();
        tamilNaduDistricts.forEach(district => {
            districtMap.set(district.name, district);
        });

        // Tamil Nadu GeoJSON URL
        const TN_GEOJSON_URL = "https://cdn.jsdelivr.net/gh/udit-001/india-maps-data@main/geojson/states/tamil-nadu.geojson";

        // Initialize Leaflet map
        const map = L.map("map", { zoomControl: true });
        
        // Add OpenStreetMap tiles
        L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
            maxZoom: 18,
            attribution: "&copy; OpenStreetMap"
        }).addTo(map);

        const panel = document.getElementById("panel");

        // Fetch and render Tamil Nadu districts
        fetch(TN_GEOJSON_URL)
            .then(r => r.json())
            .then(geojson => {
                console.log('GeoJSON loaded:', geojson);
                
                const features = geojson.features || [];
                console.log('Number of districts found:', features.length);

                const layer = L.geoJSON(geojson, {
                    style: feature => {
                        const properties = feature.properties || {};
                        const districtName = (properties.district || properties.DIST_NAME || properties.District || properties.NAME_2 || 'Unknown').toString().trim();
                        
                        console.log('District from GeoJSON:', districtName);
                        
                        // Find matching district data
                        let matchingDistrict = districtMap.get(districtName);
                        
                        // Try partial matching if exact match not found
                        if (!matchingDistrict) {
                            for (const district of tamilNaduDistricts) {
                                if (district.name.toLowerCase().includes(districtName.toLowerCase()) || 
                                    districtName.toLowerCase().includes(district.name.toLowerCase())) {
                                    matchingDistrict = district;
                                    console.log('Partial match found:', district.name, 'for', districtName);
                                    break;
                                }
                            }
                        }

                        const fillColor = matchingDistrict ? getDistrictColor(matchingDistrict.fundingStatus) : '#cccccc';
                        console.log('Color for', districtName, ':', fillColor);

                        return {
                            color: "#ffffff",        // stroke
                            weight: 2,
                            fillOpacity: 0.8,
                            fillColor: fillColor
                        };
                    },
                    onEachFeature: (feature, lyr) => {
                        const properties = feature.properties || {};
                        const districtName = (properties.district || properties.DIST_NAME || properties.District || properties.NAME_2 || 'Unknown').toString().trim();
                        
                        // Find matching district data
                        let matchingDistrict = districtMap.get(districtName);
                        
                        // Try partial matching if exact match not found
                        if (!matchingDistrict) {
                            for (const district of tamilNaduDistricts) {
                                if (district.name.toLowerCase().includes(districtName.toLowerCase()) || 
                                    districtName.toLowerCase().includes(district.name.toLowerCase())) {
                                    matchingDistrict = district;
                                    break;
                                }
                            }
                        }

                        // Hover highlight
                        lyr.on("mouseover", () => {
                            lyr.setStyle({ weight: 3, color: "#111" });
                        });
                        lyr.on("mouseout", () => {
                            lyr.setStyle({ weight: 2, color: "#fff" });
                        });

                        // Click -> side panel + popup
                        lyr.on("click", (e) => {
                            if (matchingDistrict) {
                                const coverage = getCoveragePercentage(matchingDistrict);
                                const status = getFundingStatusText(matchingDistrict.fundingStatus);
                                const statusClass = matchingDistrict.fundingStatus === 'complete' ? 'fully-funded' :
                                                  matchingDistrict.fundingStatus === 'high' ? 'well-funded' :
                                                  matchingDistrict.fundingStatus === 'medium' ? 'partial-funding' : 'needs-funding';
                                
                                panel.innerHTML = `
                                    <h2>${matchingDistrict.name}</h2>
                                    <div class="meta">Tamil Nadu District</div>
                                    <div class="status-box ${statusClass}">
                                        <strong>${status}</strong><br>
                                        Coverage: ${coverage}%<br>
                                        Schools: ${matchingDistrict.coveredSchools}/${matchingDistrict.totalSchools}
                                        ${matchingDistrict.totalSchools - matchingDistrict.coveredSchools > 0 ? 
                                          `<br><small>${matchingDistrict.totalSchools - matchingDistrict.coveredSchools} schools need sponsorship</small>` :
                                          '<br><small>All schools funded! ðŸŽ‰</small>'
                                        }
                                    </div>
                                    <div class="legend">Click other districts to compare coverage.</div>
                                `;
                            } else {
                                panel.innerHTML = `
                                    <h2>${districtName}</h2>
                                    <div class="meta">Tamil Nadu District</div>
                                    <p>District data not available yet. We're working to include all Tamil Nadu districts.</p>
                                `;
                            }
                            
                            lyr.bindPopup(`<strong>${districtName}</strong>${matchingDistrict ? `<br/>${getFundingStatusText(matchingDistrict.fundingStatus)} - ${getCoveragePercentage(matchingDistrict)}% covered` : ''}`).openPopup(e.latlng);
                        });
                    }
                }).addTo(map);

                // Fit view to Tamil Nadu bounds
                map.fitBounds(layer.getBounds(), { padding: [10, 10] });
                console.log('Tamil Nadu map rendered successfully!');
            })
            .catch(err => {
                console.error("Failed to load GeoJSON:", err);
                panel.innerHTML = `
                    <h2>TN District Explorer</h2>
                    <p>Could not load district boundaries. This might be due to network restrictions.</p>
                    <p><strong>Error:</strong> ${err.message}</p>
                    <p>The GeoJSON is loaded from: <code>https://cdn.jsdelivr.net/gh/udit-001/india-maps-data@main/geojson/states/tamil-nadu.geojson</code></p>
                `;
            });
    </script>
</body>
</html>